<form
  [formGroup]="form"
  class="dashboard-wrapper"
  [ngClass]="{
    'loading-modal': isLoading && !allProcessedFacetData
  }"
>
  <!-- Main -->

  <div class="statistics-dashboard fit-to-page">
    <!-- Left -->

    <div class="statistics-dashboard-left" *ngIf="!isShowingSearchList">
      <div *ngIf="!isShowingSearchList">
        <ul class="filters">
          <li class="container-h">
            <span class="icon filter-icon-home"> </span>
            <a
              class="filter-title padded-left"
              data-e2e="link-home"
              routerLink="/"
              >Home</a
            >
          </li>

          <li class="ct-zero container-h">
            <span [formGroup]="form" class="checkbox-labelled padded-left">
              <span
                class="checkmarked-checkbox"
                [ngClass]="{
                  checked: form.value.contentTierZero
                }"
              >
                <input
                  id="ctZero"
                  class="checkbox"
                  type="checkbox"
                  (change)="updatePageUrl()"
                  formControlName="contentTierZero"
                />
              </span>
              <label class="filter-title padded-left" for="ctZero">
                {{ form.value.contentTierZero ? "Disable" : "Enable" }}
                content tier 0
              </label>
            </span>
            <a
              class="info-icon"
              href="https://pro.europeana.eu/page/edm-documentation"
              target="_blank"
              title="Documentation"
            ></a>
          </li>
        </ul>

        <h3 class="filters-header">Filters</h3>

        <ul class="filters">
          <li>
            <ng-container *ngIf="allProcessedFacetData">
              <ng-container *ngFor="let filter of facetConf">
                <app-filter
                  [form]="form"
                  [group]="filter"
                  [options]="filterData[filter]"
                  [state]="filterStates[filter]"
                  (visibilityChanged)="closeFilters($event)"
                  (valueChanged)="updatePageUrl()"
                ></app-filter>
              </ng-container>

              <app-filter
                [form]="form"
                [group]="'dates'"
                [state]="filterStates['dates']"
                (visibilityChanged)="closeFilters($event)"
                (valueChanged)="updatePageUrl()"
              ></app-filter>
            </ng-container>
          </li>
        </ul>
      </div>

      <ul class="filters inputs" *ngIf="!isShowingSearchList">
        <li class="container-h dataset-name-wrapper">
          <span class="icon filter-icon-dataset"></span>
          <input
            formControlName="datasetName"
            (keyup.enter)="updatePageUrl()"
            placeholder="Dataset ID"
            class="dataset-name"
            type="text"
          />
        </li>
      </ul>
    </div>

    <!-- Right -->

    <div class="statistics-dashboard-right">
      <!-- Header -->

      <div class="header-bar" [ngClass]="{ 'list-mode': isShowingSearchList }">
        <ng-container *ngIf="!form.value.facetParameter">
          <h3 class="header-data">Select a facet dimension</h3>
        </ng-container>
        <ng-container *ngIf="form.value.facetParameter">
          <h3
            class="header-data"
            [title]="getFormattedContentTierParam() + getFormattedFacetParam()"
          >
            By
            <select
              class="facet-param"
              formControlName="facetParameter"
              (change)="switchFacet()"
            >
              <option *ngFor="let facet of facetConf" [ngValue]="facet">
                {{ facet | renameApiFacet }}
              </option>
            </select>
            <span
              class="svg-icon-spin"
              [ngClass]="{ showing: isLoading }"
            ></span>
          </h3>
        </ng-container>
        <ng-container *ngIf="allProcessedFacetData">
          <h3 class="link-list">
            <a (click)="setIsShowingSearchList(true)" *ngIf="!isLoading"
              >Show List</a
            >
          </h3>
          <h3 class="link-list" *ngIf="!isLoading && experimental">
            <a (click)="storeSeries()">Store Series</a>
          </h3>
          <h3 class="link-data">
            <a (click)="setIsShowingSearchList(false)">Show Data</a>
          </h3>
        </ng-container>

        <ng-container *ngIf="form.value.dateFrom && form.value.dateTo">
          <span class="date-removal" data-e2e="date-summary">
            <a
              (click)="datesClear()"
              class="date"
              *ngIf="form.value.dateFrom; let date"
            >
              {{ date }}
            </a>
            <a
              (click)="datesClear()"
              class="date"
              *ngIf="form.value.dateTo; let date"
            >
              {{ date }}
            </a>
          </span>
        </ng-container>
      </div>

      <ul class="rm-filters" [ngClass]="{ 'list-mode': isShowingSearchList }">
        <ng-container *ngFor="let filter of facetConf">
          <ng-container *ngFor="let option of getSetCheckboxValues(filter)">
            <ng-container
              *ngFor="let optionDisplay of [fromInputSafeName(option)]"
            >
              <span
                class="rm-filter"
                *ngIf="form.value[filter][option]"
                [formGroupName]="filter"
                [ngClass]="{ disabled: isDeadFacet(filter, option) }"
              >
                <!--
                  TODO: figure out the error using the template (it removes the first item - not the one clicked)
                -->
                <!--
                <app-checkbox
                  [form]="form"
                  [controlName]="toInputSafeName(option)"
                  [labelText]="option | renameRights"
                  [group]="filter"
                  [value]="option"
                  (valueChanged)="updatePageUrl()"
                ></app-checkbox>
                -->
                <span
                  class="checkbox-labelled {{ filter }}"
                  [data-filter]="filter"
                >
                  <span
                    class="checkmarked-checkbox"
                    [ngClass]="{
                      checked: form.value[filter][option]
                    }"
                  >
                    <input
                      id="cb_{{ filter }}_{{ option }}"
                      class="checkbox"
                      type="checkbox"
                      (change)="updatePageUrl()"
                      [value]="option"
                      [formControlName]="option"
                    />
                  </span>
                  <span>
                    <label
                      class="filter-label"
                      for="cb_{{ filter }}_{{ option }}"
                    >
                      {{ optionDisplay | renameRights }}
                    </label>
                  </span>
                </span>
              </span>
            </ng-container>
          </ng-container>
        </ng-container>
      </ul>

      <ng-container *ngIf="isShowingSearchList">
        <app-listing [showing]="true"></app-listing>
      </ng-container>

      <!-- Data Area -->
      <div class="data-area">
        <ngx-datatable
          *ngIf="tableData"
          #dataTable
          id="dataTable"
          [rows]="tableData.tableRows"
          [ngClass]="{ showing: !isShowingSearchList }"
          class="material expandable datatable fullscreen"
          [columnMode]="ColumnMode.flex"
          [headerHeight]="50"
          [footerHeight]="60"
          [rowHeight]="50"
          [scrollbarV]="false"
          [limit]="5"
        >
          <!-- Mobile row detail -->
          <ngx-datatable-row-detail [rowHeight]="50">
            <ng-template
              let-row="row"
              let-expanded="expanded"
              ngx-datatable-row-detail-template
            >
              <div class="mobile-row">
                <span
                  *ngFor="let col of tableData.columns | slice: 1"
                  class="mobile-row-detail"
                >
                  {{ row[col] }}</span
                >
              </div>
            </ng-template>
          </ngx-datatable-row-detail>

          <!-- Mobile controls -->
          <ngx-datatable-column
            [width]="50"
            [resizeable]="false"
            [sortable]="false"
            [draggable]="false"
            [canAutoResize]="false"
          >
            <ng-template
              let-row="row"
              let-expanded="expanded"
              ngx-datatable-cell-template
            >
              <a
                href="#"
                [class.datatable-icon-right]="!expanded"
                [class.datatable-icon-down]="expanded"
                title="Expand / Collapse Row"
                (click)="toggleExpandRow(row)"
                class="desktop-hidden"
              >
              </a>
            </ng-template>
          </ngx-datatable-column>

          <!-- Col 0 -->
          <ngx-datatable-column
            name="{{ tableData.columns[0] | titlecase }}"
            [flexGrow]="3"
            [minWidth]="200"
          >
            <ng-template let-value="value" ngx-datatable-cell-template>
              <a target="_blank" [href]="getUrlRow(value)">
                {{ value }}
              </a>
            </ng-template>
          </ngx-datatable-column>

          <!-- Col >= 1 -->
          <ngx-datatable-column
            *ngFor="let col of tableData.columns | slice: 1; index as i"
            name="{{ col | titlecase }}"
            [flexGrow]="1"
          >
            <ng-template
              let-column="column"
              let-sort="sortFn"
              ngx-datatable-header-template
            >
              <span class="mobile-hidden">{{ column.name }}</span>
            </ng-template>
            <ng-template let-value="value" ngx-datatable-cell-template>
              <span class="mobile-hidden">{{ value }}</span>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-footer *ngIf="true">
            <ng-template
              ngx-datatable-footer-template
              let-rowCount="rowCount"
              let-pageSize="pageSize"
              let-selectedCount="selectedCount"
              let-curPage="curPage"
              let-offset="offset"
            >
              <div class="table-footer">
                <div class="table-footer-total">
                  <strong>Total</strong>: {{ totalResults }}
                </div>
                <a [href]="getUrl(true)" target="_blank">View in portal</a>
              </div>

              <datatable-pager
                [pagerLeftArrowIcon]="'datatable-icon-left'"
                [pagerRightArrowIcon]="'datatable-icon-right'"
                [pagerPreviousIcon]="'datatable-icon-prev'"
                [pagerNextIcon]="'datatable-icon-skip'"
                [page]="curPage"
                [size]="pageSize"
                [count]="rowCount"
                [hidden]="!(rowCount / pageSize > 1)"
                (change)="dataTable.onFooterPage($event)"
              >
              </datatable-pager>
            </ng-template>
          </ngx-datatable-footer>
        </ngx-datatable>

        <label
          style="display: {{ isShowingSearchList ? 'none' : 'inline-block' }}"
          ><input
            type="checkbox"
            formControlName="showPercent"
            (change)="extractChartData()"
          />As percentages</label
        >

        <ul
          *ngIf="allProcessedFacetData"
          class="options-wrapper"
          [ngClass]="{ showing: !isShowingSearchList }"
          (clickOutside)="closeDisplayOptions()"
        >
          <li>
            <a #downloadAnchor></a>
          </li>

          <li class="dropdown">
            <a
              class="menu-opener"
              (click)="toggleDownloadOptions()"
              [ngClass]="{ open: downloadOptionsOpen }"
              ><h3>Downloads</h3></a
            >
            <div *ngIf="downloadOptionsOpen" class="dropdown-wrapper">
              <ul class="dropdown-content">
                <li *ngFor="let exportType of exportTypes">
                  <a (click)="export(exportType)">{{ exportType }}</a>
                </li>
              </ul>
            </div>
          </li>
        </ul>

        <!-- SNAPSHOTS -->
        <ul *ngIf="experimental">
          <!-- TODO: it should never be possible to add the current series to itself
               so add new field to CompareData (i.e. the query params as a string)
               and compare to the global (query params as string) to selectively add
          -->
          <li *ngFor="let item of compareData | keyvalue" class="compare-data">
            <a
              (click)="addSeriesToChart([item.key])"
              class="compare-data-link"
              [ngClass]="{ disabled: item.value.applied }"
              >{{ item.value.label }}</a
            >
            <a
              (click)="removeSeriesFromChart(item.key)"
              class="compare-data-link-remove"
              *ngIf="item.value.applied"
              >X</a
            >
          </li>
        </ul>
        <!-- END SNAPSHOTS -->

        <div
          *ngIf="chartData"
          class="chart-wrapper"
          [ngClass]="{ showing: !isShowingSearchList }"
        >
          <app-bar-chart
            #barChart
            [showPercent]="form.value.showPercent"
            [extraSettings]="
              ['contentTier', 'metadataTier'].includes(
                form.value.facetParameter
              )
                ? barChartSettingsTiers
                : barChartSettings
            "
            [results]="chartData"
          ></app-bar-chart>
        </div>
      </div>
    </div>
  </div>
</form>
